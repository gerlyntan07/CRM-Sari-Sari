option_settings:
  aws:elasticbeanstalk:application:environment:
    FILE_SYSTEM_ID: 'fs-0727cde1cb3550d7c'
    MOUNT_DIRECTORY: '/efs'

packages:
  yum:
    amazon-efs-utils: []

container_commands:

  01_mount_efs:
    command: |
      set -e
      EFS_MOUNT_DIR=$(/opt/elasticbeanstalk/bin/get-config environment -k MOUNT_DIRECTORY)
      EFS_FILE_SYSTEM_ID=$(/opt/elasticbeanstalk/bin/get-config environment -k FILE_SYSTEM_ID)

      if [ ! -d "${EFS_MOUNT_DIR}" ]; then
        mkdir -p "${EFS_MOUNT_DIR}"
      fi

      # Wait for mount if not already mounted
      for i in {1..5}; do
        mountpoint -q "${EFS_MOUNT_DIR}" && break
        mount -t efs -o tls ${EFS_FILE_SYSTEM_ID}:/ "${EFS_MOUNT_DIR}" && break
        sleep 2
      done

      mountpoint -q "${EFS_MOUNT_DIR}" || (echo "EFS mount failed!" && exit 1)
      echo "EFS successfully mounted."

  02_create_media_symlink:
    command: |
      set +e
      APP_DIR=/var/app/current
      MEDIA_DIR=${APP_DIR}/media
      EFS_DIR=/efs

      # Ensure app directory exists
      mkdir -p "${APP_DIR}"

      # Ensure EFS is mounted
      if mountpoint -q "${EFS_DIR}"; then
        ln -sfn "${EFS_DIR}" "${MEDIA_DIR}" || echo "Symlink creation failed, continuing."
        echo "Symlink created: ${MEDIA_DIR} â†’ ${EFS_DIR}"
      else
        echo "WARNING: ${EFS_DIR} not mounted. Skipping symlink."
      fi

  03_create_efs_media_dirs:
    command: |
      set -e
      EFS_DIR=/efs
      if mountpoint -q "${EFS_DIR}"; then
        mkdir -p ${EFS_DIR}/media/qr_codes
        chown -R webapp:webapp ${EFS_DIR}
        echo "Media subdirectories created and ownership set."
      fi
